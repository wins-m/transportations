<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>äº¤é€šè½¨è¿¹åœ°å›¾ï¼ˆåˆå¹¶+åŠ¨ç”»ï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- å¼•å…¥è·¯å¾„åŠ¨ç”»æ’ä»¶ -->
  <script src="https://unpkg.com/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.js"></script>
  <style>
    body { margin: 0; }
    #map { height: 100vh; width: 100vw; }
    .legend {
      padding: 10px;
      background: white;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }
    .route-popup { max-height: 300px; overflow-y: auto; }
  </style>
</head>
<body>
  <div id="map"></div>
  <script>
    // åˆå§‹åŒ–åœ°å›¾
    const map = L.map('map').setView([30, 110], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // åŸå¸‚åæ ‡
    const cityCoords = {
      "å®æ³¢": [29.8669, 121.5404],
      "æ­å·ä¸œ": [30.2925, 120.2119],
      "ä¸Šæµ·è™¹æ¡¥": [31.1945, 121.3188],
      "é¾™æ´å ¡T3": [26.5385, 106.8007],
      "è§å±±T4": [30.2350, 120.4340],
      "é¦™æ¸¯è¥¿ä¹é¾™": [22.3047, 114.1614]
    };

    // æ¨¡æ‹Ÿæ•°æ®ï¼ˆå®é™…æ›¿æ¢ä¸ºä½ çš„travelSegmentsï¼‰
    const travelSegments = [
      { type: "Rail", date: "2025-04-02", from: "å®æ³¢", to: "æ­å·ä¸œ", vehicle: "D3146", duration: "01:04:00" },
      { type: "Rail", date: "2024-12-01", from: "å®æ³¢", to: "æ­å·ä¸œ", vehicle: "G1234", duration: "01:02:00" },
      { type: "Rail", date: "2025-02-21", from: "æ­å·ä¸œ", to: "é¦™æ¸¯è¥¿ä¹é¾™", vehicle: "G899", duration: "10:09:00" },
      { type: "Airway", date: "2024-08-04", from: "é¾™æ´å ¡T3", to: "è§å±±T4", vehicle: "CZ2190", duration: "02:04:00" }
    ];

    // é¢œè‰²æ˜ å°„
    const typeColors = { Rail: 'blue', Airway: 'red', Other: 'green' };

    // ========= æ–¹æ¡ˆ1+3æ ¸å¿ƒé€»è¾‘ =========
    // 1. æŒ‰è¡Œç¨‹åŒºé—´åˆ†ç»„
    const routeGroups = {};
    travelSegments.forEach(segment => {
      const key = `${segment.from}-${segment.to}`;
      if (!routeGroups[key]) routeGroups[key] = [];
      routeGroups[key].push(segment);
    });

    // 2. ç»˜åˆ¶åˆå¹¶è·¯çº¿å¹¶æ·»åŠ åŠ¨ç”»
    Object.entries(routeGroups).forEach(([key, group]) => {
      const from = cityCoords[group[0].from];
      const to = cityCoords[group[0].to];
      
      // ä¸»è·¯çº¿ï¼ˆç²—ç»†åæ˜ é¢‘æ¬¡ï¼‰
      const polyline = L.polyline([from, to], {
        color: typeColors[group[0].type],
        weight: Math.min(3 + group.length, 8), // é¢‘æ¬¡è¶Šé«˜è¶Šç²—
        opacity: 0.7
      }).addTo(map);

      // 3. åŠ¨æ€åŠ¨ç”»æ•ˆæœï¼ˆéœ€æ’ä»¶ï¼‰
      L.polylineDecorator([from, to], {
        patterns: [
          {
            offset: '100%',
            repeat: '10%',  // ç®­å¤´å¯†åº¦
            symbol: L.Symbol.arrowHead({
              pixelSize: 10,
              polygon: false,
              pathOptions: {
                color: typeColors[group[0].type],
                weight: 1
              }
            })
          }
        ]
      }).addTo(map);

      // 4. åˆå¹¶å¼¹çª—å†…å®¹
      const popupContent = `
        <div class="route-popup">
          <b>${group[0].from} â†’ ${group[0].to}</b>
          <small>ï¼ˆå…± ${group.length} æ¬¡è¡Œç¨‹ï¼‰</small>
          <hr>
          ${group.map(trip => `
            <div style="margin-bottom:10px;padding-bottom:5px;border-bottom:1px dashed #eee">
              <div style="display:flex;justify-content:space-between">
                <span style="color:${typeColors[trip.type]}">
                  ${trip.type === 'Rail' ? 'ğŸš„' : 'âœˆï¸'} ${trip.date}
                </span>
                <span>${trip.vehicle}</span>
              </div>
              <div>ç”¨æ—¶: ${trip.duration}</div>
            </div>
          `).join('')}
        </div>
      `;
      polyline.bindPopup(popupContent);
    });

    // æ·»åŠ å›¾ä¾‹
    const legend = L.control({position: 'bottomright'});
    legend.onAdd = () => {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = `
        <h4>å›¾ä¾‹</h4>
        <div><span style="background:blue;width:15px;height:15px;display:inline-block;"></span> é“è·¯</div>
        <div><span style="background:red;width:15px;height:15px;display:inline-block;"></span> èˆªç©º</div>
        <div><small>çº¿å®½/ç®­å¤´æ•°é‡åæ˜ è¡Œç¨‹é¢‘æ¬¡</small></div>
      `;
      return div;
    };
    legend.addTo(map);
  </script>
</body>
</html>
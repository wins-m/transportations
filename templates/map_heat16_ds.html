<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Transportation Records</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        body {
            margin: 0;
        }

        #map {
            height: 100vh;
            width: 100vw;
        }

        .legend {
            padding: 10px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        }

        .control-panel {
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        }

        .route-popup {
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <script>
        // åˆå§‹åŒ–åœ°å›¾
        const map = L.map('map').setView([30, 110], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: '&copy; OpenStreetMap'
        }).addTo(map);

        // åŸå¸‚åæ ‡
        const locCoords = {
            "å®æ³¢ç«™": [
                29.8629414928399,
                121.53739804767
            ],
            "æ­å·ä¸œç«™": [
                30.2925,
                120.2119
            ],
            "æ·±åœ³å®å®‰T3": [
                22.627554,
                113.81184
            ],
            "æ­å·è§å±±T4": [
                30.234134,
                120.430634
            ],
            "é¦™æ¸¯è¥¿ä¹é¾™ç«™": [
                22.3047,
                114.1614
            ],
        };

        // ç¤ºä¾‹æ•°æ®ï¼ˆåŒ…å«é‡å¤è·¯çº¿ï¼‰
        const travelSegments = [
            {
                "type": "Railway",
                "date": "2025-02-21",
                "from": "æ­å·ä¸œç«™",
                "to": "é¦™æ¸¯è¥¿ä¹é¾™ç«™",
                "vehicle": "G899",
                "time": "21:15-07:24(+1)",
                "duration": "10:09:00",
                "distance": "1662 km",
                "seat": "09è½¦032å·ä¸Šé“º",
                "price": 770,
                "note": "é¦™æ¸¯è¡Œå»ç¨‹"
            },
            {
                "type": "Airline",
                "date": "2025-02-23",
                "from": "æ·±åœ³å®å®‰T3",
                "to": "æ­å·è§å±±T4",
                "vehicle": "CA1734",
                "time": "18:30-20:06",
                "duration": "01:36:00",
                "distance": "1179 km",
                "seat": "21A",
                "price": 490,
                "note": "é¦™æ¸¯è¡Œè¿”ç¨‹"
            },
            {
                "type": "Railway",
                "date": "2025-04-02",
                "from": "å®æ³¢ç«™",
                "to": "æ­å·ä¸œç«™",
                "vehicle": "D3146",
                "time": "19:38-20:42",
                "duration": "01:04:00",
                "distance": "1438 km",
                "seat": "07è½¦05A",
                "price": 57,
                "note": "ç§¯åˆ†å…‘æ¢"
            }
        ];

        // é¢œè‰²æ˜ å°„
        const typeColors = { Railway: 'blue', Airline: 'red', Other: 'black' };

        // ========= æ–¹æ¡ˆ1ï¼šåˆå¹¶ç›¸åŒè·¯çº¿ =========
        const routeGroups = {};
        travelSegments.forEach(segment => {
            const key = `${segment.from}-${segment.to}`;
            const key_rvs = `${segment.to}-${segment.from}`;
            if (!routeGroups[key]) {
                if (!routeGroups[key_rvs]) {
                    routeGroups[key] = {
                        type: segment.type,
                        segments: [],
                        polyline: null,
                    };
                    routeGroups[key].segments.push(segment);
                } else {
                    routeGroups[key_rvs].segments.push(segment);
                    return;
                }
            } else {
                routeGroups[key].segments.push(segment);
            }
        });

        // ========= æ–¹æ¡ˆ5ï¼šäº¤äº’å¼ç­›é€‰æ§ä»¶ =========
        // è·å–æ‰€æœ‰å¹´ä»½ï¼Œå»é‡æ’åº
        const years = Array.from(new Set(travelSegments.map(seg => seg.date.slice(0, 4)))).sort();

        const controlPanel = L.control({ position: 'topright' });
        controlPanel.onAdd = () => {
            const div = L.DomUtil.create('div', 'control-panel');
            div.innerHTML = `
                            <h4 style="margin:0 0 8px 0">ç­›é€‰æ¡ä»¶</h4>
                            <select id="route-type" style="width:100%;margin-bottom:6px">
                                <option value="all">æ‰€æœ‰ç±»å‹</option>
                                <option value="Railway">é“è·¯</option>
                                <option value="Airline">èˆªç©º</option>
                                <option value="Other">å…¶ä»–</option>
                            </select>
                            <select id="route-year" style="width:100%;margin-bottom:6px">
                                <option value="all">æ‰€æœ‰å¹´ä»½</option>
                                ${years.map(y => `<option value="${y}">${y}å¹´</option>`).join('')}
                            </select>
                            <div id="route-count" style="margin-top:5px;font-size:0.8em">
                                å…± ${travelSegments.length} æ¬¡è¡Œç¨‹
                            </div>
                        `;
            return div;
        };
        controlPanel.addTo(map);

        // ========= ç»˜åˆ¶åˆå¹¶è·¯çº¿ =========
        Object.entries(routeGroups).forEach(([key, group]) => {
            const from = locCoords[group.segments[0].from];
            const to = locCoords[group.segments[0].to];

            // åˆ›å»ºè·¯çº¿ï¼ˆçº¿å®½åæ˜ è¡Œç¨‹æ¬¡æ•°ï¼‰
            group.polyline = L.polyline([from, to], {
                color: typeColors[group.type],
                weight: 5 + Math.min(group.segments.length / 2, 10), // é¢‘æ¬¡è¶Šé«˜è¶Šç²—
                opacity: 0.4 + Math.min(group.segments.length * 0.05, 0.6),
                _routeType: group.type // è‡ªå®šä¹‰å±æ€§ç”¨äºç­›é€‰
            }).addTo(map);

            // åˆå¹¶å¼¹çª—å†…å®¹
            const popupContent = `
                <div class="route-popup">
                  <b>${group.segments[0].from} -ï¸ ${group.segments[0].to}</b>
                  <small>ï¼ˆ${group.segments[0].distance}, å…± ${group.segments.length} æ¬¡è¡Œç¨‹ï¼‰</small>
                  <hr>
                  ${group.segments.map(trip => `
                    <div style="margin-bottom:8px;padding-bottom:5px;border-bottom:1px dashed #eee">
                      <div style="display:flex;justify-content:space-between">
                        <span>${trip.from === group.segments[0].from ? 'â¡ï¸' : 'â¬…ï¸'}ï¸ ${trip.date}</span>
                        <span style="color:${typeColors[trip.type]}">${trip.type === 'Railway' ? 'ğŸš„' : trip.type === 'Airline' ? 'âœˆï¸' : 'ğŸšŒ'} ${trip.vehicle}</span>
                      </div>
                      <div style="display:flex;justify-content:space-between">
                        <span>${trip.time} | ${trip.seat} | Â¥${trip.price}</span>
                        <span> [${trip.note}]</span>
                      </div>
                    </div>
                  `).join('')}
                </div>
              `;
            group.polyline.bindPopup(popupContent);
        });

        // ========= ç­›é€‰åŠŸèƒ½ =========


        function updateRouteFilter() {
            const selectedType = document.getElementById('route-type').value;
            const selectedYear = document.getElementById('route-year').value;
            let visibleCount = 0;

            Object.values(routeGroups).forEach(group => {
                // åˆ¤æ–­è¯¥ç»„å†…æ˜¯å¦æœ‰ç¬¦åˆæ¡ä»¶çš„è¡Œç¨‹
                const filteredSegments = group.segments.filter(seg => {
                    const typeMatch = selectedType === 'all' || seg.type === selectedType;
                    const yearMatch = selectedYear === 'all' || seg.date.slice(0, 4) === selectedYear;
                    return typeMatch && yearMatch;
                });
                const isVisible = filteredSegments.length > 0;
                if (isVisible) {
                    if (!map.hasLayer(group.polyline)) {
                        group.polyline.addTo(map);
                    }
                    group.polyline.setStyle({
                        weight: 5 + Math.min(group.segments.length / 2, 10),
                        opacity: 0.4 + Math.min(group.segments.length * 0.05, 0.6)
                    });
                    visibleCount += filteredSegments.length;
                } else {
                    if (map.hasLayer(group.polyline)) {
                        map.removeLayer(group.polyline);
                    }
                }
            });

            document.getElementById('route-count').textContent =
                `æ˜¾ç¤º ${visibleCount}/${travelSegments.length} æ¬¡è¡Œç¨‹`;
        }

        document.getElementById('route-type').addEventListener('change', updateRouteFilter);
        document.getElementById('route-year').addEventListener('change', updateRouteFilter);

        // ========= å›¾ä¾‹å’Œæ ‡è®° =========
        const legend = L.control({ position: 'bottomright' });
        legend.onAdd = () => {
            const div = L.DomUtil.create('div', 'legend');
            div.innerHTML = `
              <h4 style="margin:4px 0">å›¾ä¾‹</h4>
              <div style="display:flex;align-items:center;gap:6px">
                <div style="background:blue;width:16px;height:16px"></div>
                <span>é“è·¯</span>
              </div>
              <div style="display:flex;align-items:center;gap:6px">
                <div style="background:red;width:16px;height:16px"></div>
                <span>èˆªç©º</span>
              </div>
              <div style="display:flex;align-items:center;gap:6px;margin:4px 0">
                <div style="background:black;width:16px;height:16px"></div>
                <span>å…¶ä»–</span>
              </div>
            `;
            return div;
        };
        legend.addTo(map);

        // æ·»åŠ åŸå¸‚æ ‡è®°
        const smallIcon = L.icon({
            iconUrl: 'https://unpkg.com/leaflet/dist/images/marker-icon.png',
            iconSize: [10, 15],
            iconAnchor: [5, 15]
        });
        Object.entries(locCoords).forEach(([name, coords]) => {
            L.marker(coords, { icon: smallIcon })
                .addTo(map)
                .bindPopup(`<b>${name}</b><br>åæ ‡: ${coords[0].toFixed(4)}, ${coords[1].toFixed(4)}`);
        });

        // è‡ªåŠ¨ç¼©æ”¾
        var markers = [];
        Object.keys(locCoords).forEach(function (city) {
            markers.push(L.latLng(locCoords[city]));
        });
        map.fitBounds(L.latLngBounds(markers), { padding: [50, 50] });

    </script>
</body>

</html>